plugins {
   id "java-library"
   id "eclipse"   
}

java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(8)
	}
}

repositories {
	mavenCentral()
	maven {
		url "https://files.minecraftforge.net/maven"
	}
}

configurations {
    implementation.extendsFrom asm
    annotationProcessor.extendsFrom asm
}

dependencies {
	compileOnly project(":Mapped-Minecraft")
			
	implementation group: "org.spongepowered", name: "mixin", version: config.mixin.version
	annotationProcessor group: "org.spongepowered", name: "mixin", version: config.mixin.version, classifier: "processor"
}

def mixin_ap = file("$buildDir/mixin_ap")
def mixin_tsrg = file("${mixin_ap}/out.tsrg")
def mixin_refmap = file("${mixin_ap}/refmap.json")

mixin_ap.mkdirs()

tasks.withType(JavaCompile) {
	options.compilerArgs += "-AdefaultObfuscationEnv=searge"
    options.compilerArgs += "-AmappingTypes=tsrg"
    options.compilerArgs += "-AreobfTsrgFile=${mapping_to_obf}"
    options.compilerArgs += "-AoutTsrgFile=${mixin_tsrg}"
    options.compilerArgs += "-AoutRefMapFile=${mixin_refmap}"
}

jar {
}

task reobfJar(type: JavaExec, dependsOn: jar) {
	assemble.dependsOn reobfJar
	
	def run = new File("$buildDir/reobf")
	if(!run.exists()) {
		run.mkdirs()
	}
	
	println rootProject.buildscript.configurations.classpath

	classpath rootProject.buildscript.configurations.classpath
	main "net.md_5.specialsource.SpecialSource"
	args "--in-jar", jar.archivePath , "--out-jar", file("$run/output.jar"), "--srg-in", mapping_to_obf, "--srg-in", mixin_tsrg, "--live"
	
	workingDir run
}